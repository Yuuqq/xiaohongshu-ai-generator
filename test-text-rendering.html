<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡å­—æ¸²æŸ“ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .content-input {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        .btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover {
            background: #3367d6;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn.secondary {
            background: #6c757d;
        }
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .result-item {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .result-image {
            width: 100%;
            height: auto;
            display: block;
            max-height: 400px;
            object-fit: contain;
        }
        .result-info {
            padding: 15px;
        }
        .result-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .result-meta {
            font-size: 12px;
            color: #666;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .comparison-item {
            text-align: center;
        }
        .comparison-item h4 {
            margin-bottom: 10px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>ğŸ”§ æ–‡å­—æ¸²æŸ“ä¿®å¤æµ‹è¯•</h1>
            <p>éªŒè¯å›¾ç‰‡ç”Ÿæˆä¸­çš„æ–‡å­—æ˜¾ç¤ºé—®é¢˜æ˜¯å¦å·²ä¿®å¤</p>
        </div>

        <!-- æµ‹è¯•1: æ¨¡æ‹Ÿç”Ÿæˆå™¨æµ‹è¯• -->
        <div class="test-section">
            <h2>æµ‹è¯•1: æ¨¡æ‹Ÿå›¾ç‰‡ç”Ÿæˆå™¨</h2>
            <p>æµ‹è¯•åŸºç¡€çš„Canvasæ–‡å­—æ¸²æŸ“åŠŸèƒ½</p>
            
            <textarea id="mockContent" class="content-input" placeholder="è¾“å…¥è¦æµ‹è¯•çš„å†…å®¹...">åˆ†äº«ä¸€ä¸ªè¶…å®ç”¨çš„æŠ¤è‚¤å°æŠ€å·§ï¼

æ¯å¤©æ™šä¸Šç”¨æ¸©æ°´æ´é¢ï¼Œé€‰æ‹©é€‚åˆè‡ªå·±è‚Œè‚¤ç±»å‹çš„æ´é¢äº§å“ã€‚è®°ä½ä¸è¦ç”¨å¤ªçƒ­çš„æ°´ï¼Œä¼šç ´åçš®è‚¤å±éšœã€‚

æ´é¢åç«‹å³æ¶‚æŠ¹ä¿æ¹¿ç²¾åï¼Œè¶ç€çš®è‚¤è¿˜æœ‰æ°´åˆ†çš„æ—¶å€™é”ä½æ°´åˆ†ã€‚æ¨èå«æœ‰é€æ˜è´¨é…¸çš„äº§å“ã€‚

æœ€åç”¨é¢éœœå½¢æˆä¿æŠ¤è†œï¼Œé˜²æ­¢æ°´åˆ†æµå¤±ã€‚å¹²æ€§çš®è‚¤å¯ä»¥é€‰æ‹©è´¨åœ°åšé‡ä¸€äº›çš„é¢éœœã€‚</textarea>
            
            <button id="testMockBtn" class="btn">æµ‹è¯•æ¨¡æ‹Ÿç”Ÿæˆå™¨</button>
            <button id="clearMockBtn" class="btn secondary">æ¸…ç©ºç»“æœ</button>
            
            <div id="mockStatus" class="status" style="display: none;"></div>
            <div id="mockResults" class="results"></div>
        </div>

        <!-- æµ‹è¯•2: é«˜çº§ç”Ÿæˆå™¨æµ‹è¯• -->
        <div class="test-section">
            <h2>æµ‹è¯•2: é«˜çº§å›¾ç‰‡ç”Ÿæˆå™¨ (Fabric.js)</h2>
            <p>æµ‹è¯•åŸºäºFabric.jsçš„é«˜çº§æ–‡å­—æ¸²æŸ“åŠŸèƒ½</p>
            
            <textarea id="advancedContent" class="content-input" placeholder="è¾“å…¥è¦æµ‹è¯•çš„å†…å®¹...">ä»Šå¤©åˆ†äº«æˆ‘çš„æŠ¤è‚¤å¿ƒå¾—

1. æ¸…æ´æ­¥éª¤
æ¸©æ°´æ´é¢ï¼Œé€‰æ‹©æ¸©å’Œçš„æ´é¢äº§å“

2. ä¿æ¹¿ç²¾å
å«æœ‰é€æ˜è´¨é…¸çš„ç²¾åæ¶²æ•ˆæœæœ€å¥½

3. é¢éœœé”æ°´
æ ¹æ®è‚Œè‚¤ç±»å‹é€‰æ‹©åˆé€‚çš„é¢éœœ

åšæŒè¿™ä¸ªæµç¨‹ï¼Œçš®è‚¤ä¼šè¶Šæ¥è¶Šå¥½ï¼</textarea>
            
            <button id="testAdvancedBtn" class="btn">æµ‹è¯•é«˜çº§ç”Ÿæˆå™¨</button>
            <button id="clearAdvancedBtn" class="btn secondary">æ¸…ç©ºç»“æœ</button>
            
            <div id="advancedStatus" class="status" style="display: none;"></div>
            <div id="advancedResults" class="results"></div>
        </div>

        <!-- å¯¹æ¯”æµ‹è¯• -->
        <div class="test-section">
            <h2>å¯¹æ¯”æµ‹è¯•</h2>
            <p>åŒæ—¶æµ‹è¯•ä¸¤ç§ç”Ÿæˆå™¨ï¼Œå¯¹æ¯”æ–‡å­—æ¸²æŸ“æ•ˆæœ</p>
            
            <textarea id="compareContent" class="content-input" placeholder="è¾“å…¥å¯¹æ¯”æµ‹è¯•å†…å®¹...">å°çº¢ä¹¦AIå›¾ç‰‡ç”Ÿæˆå™¨

è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡å­—æ¸²æŸ“çš„å†…å®¹ã€‚æˆ‘ä»¬éœ€è¦ç¡®ä¿ï¼š
â€¢ æ–‡å­—èƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤º
â€¢ ä¸­æ–‡å­—ç¬¦æ­£å¸¸æ¸²æŸ“
â€¢ æ¢è¡Œå’Œå¸ƒå±€æ­£ç¡®
â€¢ é¢œè‰²å’Œå­—ä½“æ­£å¸¸

å¦‚æœä½ èƒ½çœ‹åˆ°è¿™äº›æ–‡å­—ï¼Œè¯´æ˜ä¿®å¤æˆåŠŸäº†ï¼</textarea>
            
            <button id="testCompareBtn" class="btn">å¼€å§‹å¯¹æ¯”æµ‹è¯•</button>
            
            <div id="compareStatus" class="status" style="display: none;"></div>
            <div id="compareResults" class="comparison"></div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="assets/js/advanced-image-generator.js"></script>
    
    <script>
        let advancedGenerator = null;

        // åˆå§‹åŒ–é«˜çº§ç”Ÿæˆå™¨
        async function initAdvancedGenerator() {
            try {
                if (typeof fabric === 'undefined') {
                    throw new Error('Fabric.js æœªåŠ è½½');
                }
                
                advancedGenerator = new AdvancedImageGenerator();
                await advancedGenerator.init();
                console.log('é«˜çº§ç”Ÿæˆå™¨åˆå§‹åŒ–å®Œæˆ');
                return true;
            } catch (error) {
                console.error('é«˜çº§ç”Ÿæˆå™¨åˆå§‹åŒ–å¤±è´¥:', error);
                return false;
            }
        }

        // æ¨¡æ‹Ÿç”Ÿæˆå™¨æµ‹è¯•
        async function testMockGenerator() {
            const content = document.getElementById('mockContent').value.trim();
            if (!content) {
                showStatus('mockStatus', 'è¯·è¾“å…¥æµ‹è¯•å†…å®¹', 'error');
                return;
            }

            showStatus('mockStatus', 'æ­£åœ¨ç”Ÿæˆæ¨¡æ‹Ÿå›¾ç‰‡...', 'loading');
            document.getElementById('testMockBtn').disabled = true;

            try {
                const mockImage = await generateMockImage(content, 1);
                displayResult('mockResults', mockImage, 'æ¨¡æ‹Ÿç”Ÿæˆå™¨');
                showStatus('mockStatus', 'æ¨¡æ‹Ÿå›¾ç‰‡ç”Ÿæˆå®Œæˆ', 'success');
            } catch (error) {
                console.error('æ¨¡æ‹Ÿç”Ÿæˆå¤±è´¥:', error);
                showStatus('mockStatus', 'ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            } finally {
                document.getElementById('testMockBtn').disabled = false;
            }
        }

        // é«˜çº§ç”Ÿæˆå™¨æµ‹è¯•
        async function testAdvancedGenerator() {
            const content = document.getElementById('advancedContent').value.trim();
            if (!content) {
                showStatus('advancedStatus', 'è¯·è¾“å…¥æµ‹è¯•å†…å®¹', 'error');
                return;
            }

            if (!advancedGenerator) {
                showStatus('advancedStatus', 'é«˜çº§ç”Ÿæˆå™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }

            showStatus('advancedStatus', 'æ­£åœ¨ç”Ÿæˆé«˜çº§å›¾ç‰‡...', 'loading');
            document.getElementById('testAdvancedBtn').disabled = true;

            try {
                const template = { id: 'xiaohongshu-lifestyle' };
                const options = {
                    aspectRatio: '9:16',
                    quality: 'high',
                    backgroundStyle: 'gradient',
                    addWatermark: true
                };

                const imageData = await advancedGenerator.generateImage(content, template, options);
                displayResult('advancedResults', imageData, 'é«˜çº§ç”Ÿæˆå™¨');
                showStatus('advancedStatus', 'é«˜çº§å›¾ç‰‡ç”Ÿæˆå®Œæˆ', 'success');
            } catch (error) {
                console.error('é«˜çº§ç”Ÿæˆå¤±è´¥:', error);
                showStatus('advancedStatus', 'ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            } finally {
                document.getElementById('testAdvancedBtn').disabled = false;
            }
        }

        // å¯¹æ¯”æµ‹è¯•
        async function testComparison() {
            const content = document.getElementById('compareContent').value.trim();
            if (!content) {
                showStatus('compareStatus', 'è¯·è¾“å…¥å¯¹æ¯”æµ‹è¯•å†…å®¹', 'error');
                return;
            }

            showStatus('compareStatus', 'æ­£åœ¨è¿›è¡Œå¯¹æ¯”æµ‹è¯•...', 'loading');
            document.getElementById('testCompareBtn').disabled = true;

            try {
                // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
                document.getElementById('compareResults').innerHTML = '';

                // ç”Ÿæˆæ¨¡æ‹Ÿå›¾ç‰‡
                const mockImage = await generateMockImage(content, 1);
                displayComparison('compareResults', mockImage, 'æ¨¡æ‹Ÿç”Ÿæˆå™¨', 'left');

                // ç”Ÿæˆé«˜çº§å›¾ç‰‡
                if (advancedGenerator) {
                    const template = { id: 'xiaohongshu-lifestyle' };
                    const options = {
                        aspectRatio: '9:16',
                        quality: 'high',
                        backgroundStyle: 'gradient',
                        addWatermark: true
                    };
                    const advancedImage = await advancedGenerator.generateImage(content, template, options);
                    displayComparison('compareResults', advancedImage, 'é«˜çº§ç”Ÿæˆå™¨', 'right');
                }

                showStatus('compareStatus', 'å¯¹æ¯”æµ‹è¯•å®Œæˆ', 'success');
            } catch (error) {
                console.error('å¯¹æ¯”æµ‹è¯•å¤±è´¥:', error);
                showStatus('compareStatus', 'å¯¹æ¯”æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            } finally {
                document.getElementById('testCompareBtn').disabled = false;
            }
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿå›¾ç‰‡
        async function generateMockImage(content, index) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 540;
            canvas.height = 960;
            
            // æ¸å˜èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // æ·»åŠ æ–‡å­—
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            
            // æ ‡é¢˜
            ctx.font = 'bold 28px Arial, sans-serif';
            ctx.fillText('æ–‡å­—æ¸²æŸ“æµ‹è¯•', canvas.width / 2, 40);
            
            // å†…å®¹æ–‡å­—
            ctx.font = '18px Arial, sans-serif';
            const lines = wrapText(ctx, content, canvas.width - 80, 18);
            let currentY = 100;
            lines.forEach(line => {
                ctx.fillText(line, canvas.width / 2, currentY);
                currentY += 30;
            });
            
            // è£…é¥°è¾¹æ¡†
            ctx.strokeStyle = 'rgba(255,255,255,0.5)';
            ctx.lineWidth = 2;
            ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
            
            return new Promise((resolve) => {
                canvas.toBlob((blob) => {
                    resolve({
                        url: canvas.toDataURL(),
                        blob: blob,
                        width: canvas.width,
                        height: canvas.height
                    });
                });
            });
        }

        // æ–‡å­—æ¢è¡Œ
        function wrapText(ctx, text, maxWidth, fontSize) {
            ctx.font = `${fontSize}px Arial, sans-serif`;
            const words = text.split(/\s+/);
            const lines = [];
            let currentLine = '';

            for (let word of words) {
                const testLine = currentLine + (currentLine ? ' ' : '') + word;
                const metrics = ctx.measureText(testLine);
                
                if (metrics.width > maxWidth && currentLine) {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = testLine;
                }
            }
            
            if (currentLine) {
                lines.push(currentLine);
            }
            
            return lines.slice(0, 10); // é™åˆ¶è¡Œæ•°
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(elementId, message, type) {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.style.display = 'block';
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResult(containerId, imageData, generatorName) {
            const container = document.getElementById(containerId);
            
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';
            
            resultItem.innerHTML = `
                <img src="${imageData.url}" alt="ç”Ÿæˆçš„å›¾ç‰‡" class="result-image">
                <div class="result-info">
                    <div class="result-title">${generatorName}</div>
                    <div class="result-meta">
                        å°ºå¯¸: ${imageData.width}x${imageData.height}<br>
                        å¤§å°: ${imageData.blob ? (imageData.blob.size / 1024).toFixed(1) + ' KB' : 'æœªçŸ¥'}
                    </div>
                    <button onclick="downloadImage('${imageData.url}', '${generatorName}')" class="btn" style="margin-top: 10px;">
                        ä¸‹è½½å›¾ç‰‡
                    </button>
                </div>
            `;
            
            container.appendChild(resultItem);
        }

        // æ˜¾ç¤ºå¯¹æ¯”ç»“æœ
        function displayComparison(containerId, imageData, generatorName, side) {
            const container = document.getElementById(containerId);
            
            let comparisonItem = container.querySelector(`.comparison-${side}`);
            if (!comparisonItem) {
                comparisonItem = document.createElement('div');
                comparisonItem.className = `comparison-item comparison-${side}`;
                container.appendChild(comparisonItem);
            }
            
            comparisonItem.innerHTML = `
                <h4>${generatorName}</h4>
                <img src="${imageData.url}" alt="${generatorName}ç”Ÿæˆçš„å›¾ç‰‡" class="result-image">
                <div class="result-meta">
                    ${imageData.width}x${imageData.height}
                </div>
            `;
        }

        // ä¸‹è½½å›¾ç‰‡
        function downloadImage(dataURL, generatorName) {
            const link = document.createElement('a');
            link.download = `${generatorName}_æ–‡å­—æµ‹è¯•_${Date.now()}.png`;
            link.href = dataURL;
            link.click();
        }

        // æ¸…ç©ºç»“æœ
        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        // ç»‘å®šäº‹ä»¶
        document.getElementById('testMockBtn').addEventListener('click', testMockGenerator);
        document.getElementById('clearMockBtn').addEventListener('click', () => clearResults('mockResults'));
        document.getElementById('testAdvancedBtn').addEventListener('click', testAdvancedGenerator);
        document.getElementById('clearAdvancedBtn').addEventListener('click', () => clearResults('advancedResults'));
        document.getElementById('testCompareBtn').addEventListener('click', testComparison);

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('æ–‡å­—æ¸²æŸ“æµ‹è¯•é¡µé¢å·²åŠ è½½');
            
            // åˆå§‹åŒ–é«˜çº§ç”Ÿæˆå™¨
            const success = await initAdvancedGenerator();
            if (!success) {
                document.getElementById('testAdvancedBtn').disabled = true;
                document.getElementById('testCompareBtn').disabled = true;
            }
        });
    </script>
</body>
</html>
